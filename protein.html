<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Translator</title>
    <script src="https://3dmol.org/build/3Dmol-min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --window-bg: rgba(28, 28, 35, 0.85);
            --border-color: rgba(255, 255, 255, 0.1);
            --header-color: rgba(255, 255, 255, 0.9);
            --text-color: rgba(255, 255, 255, 0.8);
            --accent-color: #1e1597;
            --window-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --window-blur: blur(12px);
        }

        html, body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at center, #1a1a2e, #000000);
            color: var(--text-color);
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }

        .floating-window {
            position: fixed;
            background: var(--window-bg);
            backdrop-filter: var(--window-blur);
            -webkit-backdrop-filter: var(--window-blur);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--window-shadow);
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .window-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border-color);
            background: rgba(72, 8, 129, 0.255);
            margin-bottom: 15px;
        }

        .window-header h2 {
            font-size: 1.1em;
            font-weight: 500;
            color: var(--header-color);
            margin: 0;
        }



        #input-window {
            top: 0;
            left: 0;
            width: 35vw;
            height: 100vh;
            overflow-y: auto;
            border-radius: 0;
        }

        #input-window::-webkit-scrollbar {
            width: 0px;
        }

        #input-window::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0);
        }

        #input-window::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        #input-window::-webkit-scrollbar-thumb:hover {
            background: rgba(3, 0, 0, 0);
        }

        #viewer-window {
            top: 0;
            left: 35vw;
            width: 65vw;
            height: 100vh;
            overflow: hidden;
            border-radius: 0;
            border-left: 1px solid var(--border-color);
        }
        #dnaInput {
            width: 100%;
            margin: 15px 0 25px 0;
            padding: 15px;
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            resize: vertical;
            min-height: 80px;
            max-height: 200px;
            transition: all 0.3s ease;
            box-sizing: border-box;
            line-height: 1.5;
        }

        #dnaInput:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.08);
        }

        button {
            background: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #73d40b97;
            transform: translateY(-1px);
        }

        .output {
            margin: 35px 0;
            font-family: 'Space Mono', monospace;
            white-space: pre-wrap;
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 100%;
            box-sizing: border-box;
            line-height: 1.5;
            font-size: 14px;
        }
        .codon-highlight {
            padding: 2px 4px;
            border-radius: 3px;
        }
        .start-codon {
            background-color: green;
            color: rgb(215, 209, 209);
        }
        .stop-codon {
            background-color: red;
            color: white;
        }
        .error {
            color: red;
            border: 1px solid red;
        }
        #viewer {
            width: 100%;
            height: calc(100% - 100px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #viewer canvas {
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            color: var(--text-color);
            padding: 20px;
            font-size: 1.1em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .viewer-container {
            position: relative;
            width: 100%;
            height: calc(100% - 80px);
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        .codon-table {
            margin-top: 20px;
            font-size: 12px;
        }
        .input-section {
            margin: 25px 0 35px 0;
            padding: 0 15px;
        }

        .main-label {
            font-size: 18px;
            font-weight: 500;
            color: var(--header-color);
            margin-bottom: 8px;
            display: block;
        }

        .input-hint {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .codon-legend {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .codon-legend span {
            display: flex;
            align-items: center;
            min-width: 1px;
        }

        .codon-table {
            margin: 20px 0 20px 0;
        }

        .codon-table table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            margin-top: 15px;
        }

        .codon-table td:first-child {
            width: 120px;
        }

        .codon-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 6px;
            background-color: transparent;
            border: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .start-dot {
            background-color: #4CAF50;
            border: none;
        }

        .stop-dot {
            background-color: #ff5f56;
            border: none;
        }

        .codon-table th, .codon-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
            color: var(--text-color);
        }

        .codon-table th {
            background: rgba(255, 255, 255, 0.05);
            color: var(--header-color);
            font-weight: 500;
        }

        .mutation-section {
            margin: 35px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            width: 100%;
        }

        .mutation-section h3 {
            margin: 0 0 25px 0;
            color: var(--header-color);
            font-size: 1.2em;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .mutation-section label {
            display: block;
            margin-bottom: 12px;
            color: var(--text-color);
            font-size: 14px;
        }

        .mutation-section input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            box-sizing: border-box;
        }

        .mutation-section input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.08);
        }

        #mutatePosition, #newNucleotide {
            width: 100%;
        }

        .translation-results {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .result-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .result-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .result-section h3 {
            color: var(--header-color);
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .sequence {
            font-family: 'Space Mono', monospace;
            word-break: break-all;
            line-height: 1.6;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .codons {
            line-height: 2;
            word-spacing: 8px;
        }

        .protein-sequence {
            color: #4CAF50;
            line-height: 1.6;
            padding: 8px;
            word-spacing: 4px;
        }

        .sequence-group {
            margin-top: 10px;
        }

        .sequence-label {
            color: var(--header-color);
            font-size: 0.9em;
            margin-top: 12px;
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .mutation-comparison {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .effect-summary {
            color: var(--text-color);
            padding: 12px 15px;
            border-radius: 6px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.03);
            font-size: 0.95em;
            border: 1px solid var(--border-color);
        }

        .effect-summary strong {
            color: var(--header-color);
            display: block;
            margin-bottom: 5px;
        }

        .mutation-effect {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .results-panel {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .results-panel h3 {
            color: var(--header-color);
            font-size: 1.2em;
            font-weight: 500;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .output-section {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease, max-height 0.5s ease;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0;
        }
        
        .output-section.visible {
            opacity: 1;
            max-height: 2000px;
            padding: 15px;
        }

        .output-section.visible {
            display: block;
        }

        #mutation-output {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="floating-window" id="input-window">
        <div class="window-header">
            <h2>Input & Translation</h2>
        </div>
        <div class="window-content">
            <div class="input-section">
                <label for="dnaInput" class="main-label">Enter DNA Sequence</label>
                <div class="input-hint">Accepted nucleotides: A, T, G, C</div>
                <textarea id="dnaInput" placeholder="e.g., ATGGCCATTGAA..." rows="3"></textarea>
                <button onclick="translate()">Translate to Protein</button>
            </div>
            
            <div class="mutation-section">
                <h3>Mutation Simulator</h3>
                <label for="mutatePosition">Position to Mutate (1-based):</label>
                <input type="number" id="mutatePosition" min="1" placeholder="e.g., 1">
                <label for="newNucleotide">New Nucleotide (A, T, G, C):</label>
                <input type="text" id="newNucleotide" maxlength="1" placeholder="e.g., A">
                <button onclick="mutateAndTranslate()">Apply Mutation</button>
            </div>
            
            <div class="results-panel">
                <h3>Results Output</h3>
                <div class="results-container">
                    <div id="translation-output" class="output-section">
                        <div class="result-content"></div>
                    </div>
                    <div id="mutation-output" class="output-section">
                        <div class="result-content"></div>
                    </div>
                </div>
            </div>
            
            <h3>Codon Table Reference</h3>
            <div class="codon-legend">
                <span><span class="codon-dot start-dot"></span> Start Codon</span>
                <span><span class="codon-dot stop-dot"></span> Stop Codon</span>
            </div>
            <div class="codon-table">
                <table>
                    <thead>
                        <tr>
                            <th>Codon</th>
                            <th>Amino Acid</th>
                            <th>3-letter</th>
                            <th>1-letter</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="codonTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>
    
    <div class="floating-window" id="viewer-window">
        <div class="window-header">
            <h2>3D Protein Structure</h2>
        </div>
        <div class="viewer-container">
            <p id="structureStatus" class="loading">Translate a sequence to view the 3D structure here.</p>
            <div id="viewer" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Genetic Code Map (RNA codons)
        const codonData = {
            // U first position
            'UUU': { name: 'Phenylalanine', code3: 'Phe', code1: 'F' },
            'UUC': { name: 'Phenylalanine', code3: 'Phe', code1: 'F' },
            'UUA': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'UUG': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'UCU': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'UCC': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'UCA': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'UCG': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'UAU': { name: 'Tyrosine', code3: 'Tyr', code1: 'Y' },
            'UAC': { name: 'Tyrosine', code3: 'Tyr', code1: 'Y' },
            'UAA': { name: '— Stop —', code3: '—', code1: '—', note: 'Stop' },
            'UAG': { name: '— Stop —', code3: '—', code1: '—', note: 'Stop' },
            'UGU': { name: 'Cysteine', code3: 'Cys', code1: 'C' },
            'UGC': { name: 'Cysteine', code3: 'Cys', code1: 'C' },
            'UGA': { name: '— Stop —', code3: '—', code1: '—', note: 'Stop (also Sec in some contexts)' },
            'UGG': { name: 'Tryptophan', code3: 'Trp', code1: 'W' },
            
            // C first position
            'CUU': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'CUC': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'CUA': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'CUG': { name: 'Leucine', code3: 'Leu', code1: 'L' },
            'CCU': { name: 'Proline', code3: 'Pro', code1: 'P' },
            'CCC': { name: 'Proline', code3: 'Pro', code1: 'P' },
            'CCA': { name: 'Proline', code3: 'Pro', code1: 'P' },
            'CCG': { name: 'Proline', code3: 'Pro', code1: 'P' },
            'CAU': { name: 'Histidine', code3: 'His', code1: 'H' },
            'CAC': { name: 'Histidine', code3: 'His', code1: 'H' },
            'CAA': { name: 'Glutamine', code3: 'Gln', code1: 'Q' },
            'CAG': { name: 'Glutamine', code3: 'Gln', code1: 'Q' },
            'CGU': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            'CGC': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            'CGA': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            'CGG': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            
            // A first position
            'AUU': { name: 'Isoleucine', code3: 'Ile', code1: 'I' },
            'AUC': { name: 'Isoleucine', code3: 'Ile', code1: 'I' },
            'AUA': { name: 'Isoleucine', code3: 'Ile', code1: 'I' },
            'AUG': { name: 'Methionine', code3: 'Met', code1: 'M', note: 'Start (also codes Met internally)' },
            'ACU': { name: 'Threonine', code3: 'Thr', code1: 'T' },
            'ACC': { name: 'Threonine', code3: 'Thr', code1: 'T' },
            'ACA': { name: 'Threonine', code3: 'Thr', code1: 'T' },
            'ACG': { name: 'Threonine', code3: 'Thr', code1: 'T' },
            'AAU': { name: 'Asparagine', code3: 'Asn', code1: 'N' },
            'AAC': { name: 'Asparagine', code3: 'Asn', code1: 'N' },
            'AAA': { name: 'Lysine', code3: 'Lys', code1: 'K' },
            'AAG': { name: 'Lysine', code3: 'Lys', code1: 'K' },
            'AGU': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'AGC': { name: 'Serine', code3: 'Ser', code1: 'S' },
            'AGA': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            'AGG': { name: 'Arginine', code3: 'Arg', code1: 'R' },
            
            // G first position
            'GUU': { name: 'Valine', code3: 'Val', code1: 'V' },
            'GUC': { name: 'Valine', code3: 'Val', code1: 'V' },
            'GUA': { name: 'Valine', code3: 'Val', code1: 'V' },
            'GUG': { name: 'Valine', code3: 'Val', code1: 'V', note: '(GUG can also serve as start in prokaryotes)' },
            'GCU': { name: 'Alanine', code3: 'Ala', code1: 'A' },
            'GCC': { name: 'Alanine', code3: 'Ala', code1: 'A' },
            'GCA': { name: 'Alanine', code3: 'Ala', code1: 'A' },
            'GCG': { name: 'Alanine', code3: 'Ala', code1: 'A' },
            'GAU': { name: 'Aspartic acid', code3: 'Asp', code1: 'D' },
            'GAC': { name: 'Aspartic acid', code3: 'Asp', code1: 'D' },
            'GAA': { name: 'Glutamic acid', code3: 'Glu', code1: 'E' },
            'GAG': { name: 'Glutamic acid', code3: 'Glu', code1: 'E' },
            'GGU': { name: 'Glycine', code3: 'Gly', code1: 'G' },
            'GGC': { name: 'Glycine', code3: 'Gly', code1: 'G' },
            'GGA': { name: 'Glycine', code3: 'Gly', code1: 'G' },
            'GGG': { name: 'Glycine', code3: 'Gly', code1: 'G' }
        };

            // Function to populate codon table
        function populateCodonTable() {
            const tbody = document.getElementById('codonTableBody');
            tbody.innerHTML = '';
            
            // Sort codons alphabetically
            const sortedCodons = Object.entries(codonData).sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedCodons.forEach(([rnaCodon, data]) => {
                const row = document.createElement('tr');
                
                // Codon cell with dot and both DNA/RNA versions
                const codonCell = document.createElement('td');
                const dot = document.createElement('span');
                dot.className = 'codon-dot';
                
                // Convert RNA codon to DNA for display
                const dnaCodon = rnaCodon.replace(/U/g, 'T');
                
                if (rnaCodon === 'AUG') {
                    dot.classList.add('start-dot');
                    dot.title = 'Start Codon';
                } else if (['UAA', 'UAG', 'UGA'].includes(rnaCodon)) {
                    dot.classList.add('stop-dot');
                    dot.title = 'Stop Codon';
                }
                
                codonCell.appendChild(dot);
                codonCell.appendChild(document.createTextNode(` ${dnaCodon} (${rnaCodon})`));
                
                // Create other cells
                const nameCell = document.createElement('td');
                nameCell.textContent = data.name;
                
                const code3Cell = document.createElement('td');
                code3Cell.textContent = data.code3;
                
                const code1Cell = document.createElement('td');
                code1Cell.textContent = data.code1;
                
                const noteCell = document.createElement('td');
                noteCell.textContent = data.note || '';
                if (data.note) {
                    noteCell.classList.add('note-cell');
                }
                
                // Add all cells to row
                row.appendChild(codonCell);
                row.appendChild(nameCell);
                row.appendChild(code3Cell);
                row.appendChild(code1Cell);
                row.appendChild(noteCell);
                
                tbody.appendChild(row);
            });
        }        // Validate and clean DNA input
        function cleanDNA(dna) {
            return dna.toUpperCase().replace(/[^ATGC]/g, '');


        }
        document.addEventListener("DOMContentLoaded", populateCodonTable);

        function translateDNA(dna) {
    const cleaned = cleanDNA(dna);

    if (cleaned.length < 3 || cleaned.length % 3 !== 0) {
        return { valid: false, error: "DNA length must be multiple of 3 and contain only A, T, G, C." };
    }

    const mrna = cleaned.replace(/T/g, "U");
    const codons = mrna.match(/.{1,3}/g) || [];

    let protein = "";
    let hasStart = false;

    for (let i = 0; i < codons.length; i++) {
        const codon = codons[i];
        const aa = codonData[codon];

        if (!aa) continue; // skip invalid codons

        if (!hasStart) {
            if (codon === "AUG") {
                hasStart = true;
                protein += aa.code1;
            }
        } else {
            if (["UAA", "UAG", "UGA"].includes(codon)) break; // stop codon
            protein += aa.code1;
        }
    }

    return {
        valid: true,
        cleaned,
        mrna,
        codons,
        protein,
        hasStart
    };
}

        function formatProteinSequence(result) {
    const codons = result.codons;
    let proteinNames = [];
    let hasStarted = false;

    for (let i = 0; i < codons.length; i++) {
        const codon = codons[i];
        const aa = codonData[codon];

        if (!aa) continue;

        if (!hasStarted) {
            if (codon === "AUG") {
                hasStarted = true;
                proteinNames.push(aa.name);
            }
        } else {
            if (["UAA", "UAG", "UGA"].includes(codon)) break;
            proteinNames.push(aa.name);
        }
    }
    return proteinNames.join(" - ");
}

        function loadStructure(proteinSeq) {
    const viewer = $3Dmol.createViewer("viewer", { backgroundColor: "black" });
    viewer.clear();

    // For demo: load a small peptide (not real structure for input sequence)
    const pdbData = `
HETATM    1  N   ALA A   1      -0.000   0.000   0.000
HETATM    2  C   ALA A   1       1.500   0.000   0.000
HETATM    3  O   ALA A   1       2.000   1.200   0.000
    `;
    viewer.addModel(pdbData, "pdb");
    viewer.setStyle({}, { cartoon: { color: "spectrum" } });
    viewer.zoomTo();
    viewer.render();
}
        
        // Main translate function
        function translate() {
    const rawInput = document.getElementById('dnaInput').value;
    const translationOutput = document.getElementById('translation-output');
    const resultContent = translationOutput.querySelector('.result-content') || translationOutput;

    // clear previous UI states
    document.getElementById('dnaInput').classList.remove('error');
    document.getElementById('mutation-output').classList.remove('visible');

    // simple empty check
    if (!rawInput || rawInput.trim().length === 0) {
        resultContent.innerHTML = '<div class="error">Please enter a DNA sequence.</div>';
        translationOutput.classList.add('visible');
        document.getElementById('dnaInput').classList.add('error');
        return;
    }

    // use your helper which cleans the input and validates length/codons
    const result = translateDNA(rawInput); // translateDNA does cleaning and validation

    if (!result.valid) {
        // show the error returned by translateDNA
        resultContent.innerHTML = `<div class="error">${result.error}</div>`;
        translationOutput.classList.add('visible');
        document.getElementById('dnaInput').classList.add('error');

        // ensure viewer shows no structure
        document.getElementById('viewer').style.display = 'none';
        document.getElementById('structureStatus').style.display = 'block';
        document.getElementById('structureStatus').textContent = 'No valid protein sequence to display.';
        return;
    }

    // Format display values
    const proteinOneLetter = result.protein || '';
    const proteinDisplay = result.hasStart ? proteinOneLetter : 'No protein sequence (no start codon found)';
    const proteinFullNames = result.hasStart ? formatProteinSequence(result) : '';

    // Build HTML
    const html = `
        <div class="result-section">
            <h3>Translation Results</h3>
            <div class="sequence-group">
                <div class="sequence-label">DNA:</div>
                <div class="sequence">${result.cleaned}</div>

                <div class="sequence-label">mRNA:</div>
                <div class="sequence">${result.mrna}</div>

                <div class="sequence-label">Codons:</div>
                <div class="codons">${result.codons.join(' ')}</div>

                <div class="sequence-label">Protein (1-letter):</div>
                <div class="protein-sequence">${proteinDisplay}</div>

                ${proteinFullNames ? `
                <div class="sequence-label">Protein (full names):</div>
                <div class="sequence">${proteinFullNames}</div>` : ''}
            </div>
        </div>
    `;

    // Insert and reveal
    resultContent.innerHTML = html;
    translationOutput.classList.add('visible');

    // Show / hide 3D viewer (only when there's a start codon and protein)
    if (result.hasStart && proteinOneLetter.length > 0) {
        document.getElementById('viewer').style.display = 'block';
        document.getElementById('structureStatus').style.display = 'none';
        loadStructure(result.protein);
    } else {
        document.getElementById('viewer').style.display = 'none';
        document.getElementById('structureStatus').style.display = 'block';
        document.getElementById('structureStatus').textContent = 'No valid protein sequence to display.';
    }

    // tidy up UI
    document.getElementById('dnaInput').classList.remove('error');
    document.getElementById('mutation-output').classList.remove('visible');
}
        

        // Mutation simulator function
        function mutateAndTranslate() {
            const input = document.getElementById('dnaInput').value.toUpperCase();
            const position = parseInt(document.getElementById('mutatePosition').value);
            const newNucleotide = document.getElementById('newNucleotide').value.toUpperCase();
            const mutationOutput = document.getElementById('mutation-output');

            // Clear previous error states
            document.getElementById('mutatePosition').classList.remove('error');
            document.getElementById('newNucleotide').classList.remove('error');
            
            // Validate inputs
            if (!input) {
                mutationOutput.innerHTML = '<div class="error">Please enter a DNA sequence first.</div>';
                mutationOutput.classList.add('visible');
                return;
            }

            // Validate inputs
            const cleaned = cleanDNA(input);
            if (cleaned.length === 0 || cleaned.length % 3 !== 0) {
                mutationOutput.innerHTML = '<span class="error">Invalid DNA sequence! Must contain only A, T, G, C and length multiple of 3.</span>';
                document.getElementById('dnaInput').classList.add('error');
                mutationOutput.classList.add('visible');
                return;
            }
            if (position < 1 || position > cleaned.length) {
                mutationOutput.innerHTML = '<span class="error">Position must be between 1 and ' + cleaned.length + '.</span>';
                document.getElementById('mutatePosition').classList.add('error');
                mutationOutput.classList.add('visible');
                return;
            }

            if (!['A', 'T', 'G', 'C'].includes(newNucleotide)) {
                mutationOutput.innerHTML = '<div class="error">Invalid nucleotide! Use A, T, G, or C.</div>';
                document.getElementById('newNucleotide').classList.add('error');
                mutationOutput.classList.add('visible');
                return;
            }

            if (position < 1 || position > input.length) {
                mutationOutput.innerHTML = '<div class="error">Position must be between 1 and ' + input.length + '.</div>';
                document.getElementById('mutatePosition').classList.add('error');
                mutationOutput.classList.add('visible');
                return;
            }

            // Apply mutation
            const mutatedDNA = input.substring(0, position - 1) + newNucleotide + input.substring(position);
            // Update input field with mutated sequence
            document.getElementById('dnaInput').value = mutatedDNA;

            // Translate the mutated sequence
            const mrna = mutatedDNA.replace(/T/g, 'U');
            const codons = mrna.match(/.{1,3}/g) || [];
            
            let protein = '';
            let hasStart = false;
            const highlightedCodons = [];

            for (let i = 0; i < codons.length; i++) {
                const codon = codons[i];
                const dnaCodon = mutatedDNA.substr(i * 3, 3);
                const aminoAcid = codonData[codon];

                if (!aminoAcid) continue;

                let className = '';
                if (codon === 'AUG') {
                    className = 'start-codon';
                    hasStart = true;
                } else if (['UAA', 'UAG', 'UGA'].includes(codon)) {
                    className = 'stop-codon';
                }

                highlightedCodons.push(
                    `<span class="codon-highlight ${className}">${dnaCodon} → ${codon} → ${aminoAcid.code1}</span>`
                );

                if (hasStart && !['UAA', 'UAG', 'UGA'].includes(codon)) {
                    protein += aminoAcid.code1;
                }
                
                if (['UAA', 'UAG', 'UGA'].includes(codon)) {
                    break;
                }
            }

                mutationOutput.innerHTML = `
    <div class="result-section mutation-comparison">
        <h3>Mutation at Position ${position} → ${newNucleotide}:</h3>
        <div class="sequence-group">
            <div class="sequence-label">Mutated DNA:</div>
            <div class="sequence">${mutatedResult.cleaned}</div>
            <div class="sequence-label">Mutated mRNA:</div>
            <div class="sequence">${mutatedResult.mrna}</div>
            <div class="sequence-label">Mutated Codons:</div>
            <div class="codons">${mutatedResult.codons.join(' ')}</div>
            <div class="sequence-label">Mutated Protein:</div>
            <div class="protein-sequence">${mutatedProtein}</div>
        </div>
        <div class="mutation-effect">
            <div class="effect-summary">
                <strong>Effect of Mutation:</strong> ${
                    originalProtein === mutatedProtein ? 
                    'Silent mutation - no change in protein sequence' : 
                    'Protein sequence changed'
                }
            </div>
        </div>
    </div>`;
                mutationOutput.classList.add('visible');
                loadStructure(mutatedResult.protein);
            }
        

        // Load 3D structure using 3Dmol.js
        function loadStructure(proteinSeq) {
            const status = document.getElementById('structureStatus');
            const viewer = document.getElementById('viewer');
            
            // Show loading message and hide viewer
            status.style.display = 'block';
            viewer.style.display = 'none';
            viewer.innerHTML = ''; // Clear previous

            // For demo, use a fixed PDB like 1CRN (crambin protein).
            const pdbUrl = 'https://files.rcsb.org/download/1CRN.pdb'; // Example PDB

            status.textContent = 'Loading 3D structure... (Demo using example protein)';

            let config = {
                backgroundColor: 'transparent',
                antialias: true,
                id: 'viewer',
            };

            let molViewer = $3Dmol.createViewer(viewer, config);
            molViewer.addModel(pdbUrl, "pdb");
            molViewer.setStyle({}, {cartoon: {color: 'spectrum', opacity: 0.95}});
            molViewer.setBackgroundColor('transparent');
            molViewer.zoomTo();
            molViewer.render();

            molViewer.spin(true); // Auto-spin for immersive feel

            // Hide loading message and show viewer
            status.style.display = 'none';
            viewer.style.display = 'block';
        }

        // Initialize
        populateCodonTable();
    </script>
</body>
</html>